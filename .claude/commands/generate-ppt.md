# PDF 转 Marp 演示文稿

将用户提供的 PDF 自动转化为高质量 Marp 演示文稿（Markdown + HTML + PDF）。

**用户输入**: `$ARGUMENTS`（PDF 文件路径）

---

## 必读文档

在开始任何操作之前，你**必须**先阅读以下文件，全部读完后再进入执行流程：

1. `docs/sop.md` — 完整的生成标准操作流程
2. `docs/content-limits.md` — 各布局的内容上限规则（**必须严格遵守，这是防止内容溢出的核心依据**）
3. `docs/theme-reference.md` — consulting 主题所有样式类完整参考

另外在 Step 3 规划阶段需要浏览：
4. `components/` 目录下的交互组件文件 — 了解可用的交互增强选项

---

## 执行流程

### Step 1: 快速了解需求

向用户依次询问以下 3 个问题（每个问题给出选项，让用户直接选择）：

**问题 1 — 用途**：
> 这份演示文稿的用途是什么？
> 1. 汇报（向上汇报/述职/工作总结）
> 2. 课件（教学/培训/讲座）
> 3. 招商（投融资/商业计划书/产品推介）
> 4. 培训（内部培训/操作手册/流程说明）
> 5. 其他（请简要说明）

**问题 2 — 目标页数**：
> 你希望生成大约多少页？
> 1. 10 页以内（精简版）
> 2. 10-20 页（标准版）
> 3. 20-30 页（详细版）
> 4. 30 页以上（完整版）

**问题 3 — 输出语言**：
> 输出语言偏好？
> 1. 中文
> 2. 英文
> 3. 中英混合

收集完毕后，简要复述用户的选择，然后进入下一步。

---

### Step 2: 解析 PDF

确认用户提供的 PDF 路径为 `$ARGUMENTS`，执行以下操作：

#### 2.1 运行提取脚本

```bash
python scripts/extract_pdf.py "$ARGUMENTS" output
```

如果脚本执行失败，检查：
- PDF 路径是否存在：`ls -la "$ARGUMENTS"`
- Python 依赖是否安装：`pip install PyMuPDF`（或 `pip3 install PyMuPDF`）
- 如果路径包含空格，确保用引号包裹

#### 2.2 读取提取结果

读取 `output/extracted.json`，了解：
- 总页数（`metadata.page_count`）
- PDF 标题（`metadata.title`）
- 每页文字内容（`pages` 数组）
- 提取的图片列表（`images` 数组）

#### 2.3 检查图片（像素级分析）

浏览 `output/images/` 目录，并**读取 extracted.json 中每张图片的 `width` × `height` 像素值**：

1. **筛选**：排除过小图片（宽或高 < 100px）和装饰性图片
2. **分类**：根据宽高比归类——横图（w/h > 1.3）、方图（0.77~1.3）、竖图（w/h < 0.77）
3. **布局决策**：
   - 横图 > 800px 宽 → `cols-2-64`（图在宽侧）或 `rows-2`（图在上方）
   - 横图 400-800px → `cols-2`（图文各占一半）
   - 横图 < 400px → 嵌入文字中，上下添加说明文字
   - 竖图 → `cols-2-37`/`cols-2-46`（图在窄侧，文字在宽侧）
   - 方图 → `cols-2`（图文各半）
4. **小图规则**：图片高度 < 350px 时，不要让图片独占整栏，应在同一 div 上下添加文字。此时使用 `ldiv`/`rdiv`（不要用 `limg`/`rimg`，后者会居中导致无法加文字）

---

### Step 3: 分析内容并制定方案

这是最关键的规划步骤。你需要综合 PDF 内容、用户需求、content-limits 规则来制定生成方案。

#### 3.1 内容结构分析

阅读 `output/extracted.json` 中的全部文字内容，识别：
- **章节层级**：找出大标题、小标题、段落的层级关系
- **数据表格**：识别文本中的结构化数据（数字对比、指标列表等），判断是否适合用表格呈现
- **关键图片**：筛选出与内容强相关的图片，规划图片的放置位置
- **内容密度**：评估每个章节的文字量，预估需要几页来承载

#### 3.2 页面规划

基于分析结果，为每一页制定计划：

| 页码 | 标题 | 布局类型 | 内容来源 | 交互组件 | 备注 |
|------|------|---------|---------|---------|------|
| 1 | 封面 | cover_c | PDF 标题 | 无 | 背景图 |
| 2 | 目录 | toc_a | 章节列表 | 无 | |
| 3 | 章节过渡 | trans | 第一章标题 | 无 | |
| ... | ... | ... | ... | ... | ... |

**规划时必须查阅 `docs/content-limits.md`**，确保每页的内容量不超过对应布局的上限。

#### 3.3 布局选择原则

查阅 `docs/theme-reference.md` 获取所有可用布局，遵循以下原则：
- **优先使用左右分栏**（`cols-2` 系列），视觉效果好，内容利用率高
- **谨慎使用上下分栏**（`rows-2` 系列），仅在内容逻辑确实是"上下关系"时使用（如：表格+分析、数据+结论）
- **非对称分栏**（如 `cols-2-64`、`cols-2-73`）时，确保窄侧有足够密集的内容（关键指标、简短列表、小表格），不要让窄侧显得空旷
- **三栏**（`cols-3`）适合并列对比（如三个方案、三个阶段）
- **导航栏**（`navbar`）用于多章节的正式汇报，帮助观众定位当前位置
- **引用盒子**（`bq-green`/`bq-red`/`bq-blue`/`bq-black`）适合重点结论或策略建议页
- **smalltext** 适合需要展示大量细节的页面（如附录），**largetext** 适合核心数字和关键结论

#### 3.4 交互组件评估

浏览 `components/` 目录中的组件文件，评估哪些内容适合加交互增强：
- **数据对比** → `progress-bars.html`（进度条）、`charts-css.html`（图表）
- **流程/时间线** → `timeline.html`（时间线）
- **分类信息** → `tab-switch.html`（标签切换）、`filter-list.html`（筛选列表）
- **详细展开** → `collapsible.html`（折叠面板）
- **正反对比** → `flip-card.html`（翻转卡片）
- **指标展示** → `animated-counters.html`（动画计数器）、`hover-cards.html`（悬停卡片）

注意：交互组件仅在 HTML 输出中生效，PDF 输出为静态降级。建议每份演示文稿使用 1-3 个交互组件即可，不要过度使用。

---

### Step 4: 确认方案

将完整的生成方案展示给用户，包括：

1. **总览信息**：总页数、使用的布局类型分布、是否使用 navbar、使用的交互组件
2. **页面清单**：列出每页的标题、布局、内容概要（用简短描述）
3. **特别说明**：哪些内容被压缩了、哪些图片被选用了、哪些内容建议拆分为多页

然后询问用户：
> 以上是生成方案，你是否需要修改？可以调整：
> - 增删某些页面
> - 更换某页的布局
> - 调整内容取舍
> - 添加或移除交互组件
>
> 如果没问题，我将开始生成。

等待用户确认后再进入下一步。如果用户要求修改，调整方案后再次展示确认。

---

### Step 5: 并行生成 Markdown 文件（章节级 Agent 调度）

用户确认方案后，**必须**按以下流程分章节并行生成，而不是串行写完整文件。

#### 5.0 调度总流程

```
主 Agent（调度器）
│
├── 1. 自己写：frontmatter + 封面页 + 目录页
│
├── 2. 按章节拆分，每章启动一个 Task Agent（并行）
│   ├── Agent-Ch1: 过渡页 + 该章所有内容页
│   ├── Agent-Ch2: 过渡页 + 该章所有内容页
│   ├── Agent-Ch3: 过渡页 + 该章所有内容页
│   └── ...
│
├── 3. 自己写：结束页（lastpage）
│
└── 4. 收集所有 Agent 返回的 Markdown 片段，按顺序拼接写入文件
```

**调度规则：**

1. **主 Agent 负责全局**：frontmatter、封面、目录、结束页由主 Agent 直接生成，不拆分
2. **每章一个 Agent**：使用 `Task` 工具，`subagent_type: "general-purpose"`，为每章启动一个独立 Agent
3. **并行启动**：所有章节 Agent 在**同一条消息**中通过多个 `Task` 调用并行启动
4. **Agent Prompt 模板**：每个 Agent 的 prompt 必须包含以下信息：
   - 该章的页面规划表（页码、标题、布局、内容来源）
   - navbar 的完整章节列表和当前章节标记规则
   - 对应的 PDF 文字内容（从 extracted.json 中提取该章相关页面的文字）
   - 该章要用到的图片列表及其像素尺寸
   - 关键规则提醒（完整句子、总起句、内容上限、图片路径规则）
   - 明确要求：返回纯 Markdown 文本，不要包含 frontmatter，不要包含 `---` 分页符（headingDivider 会自动分页）
5. **拼接顺序**：主 Agent 收到所有 Agent 返回后，按 `封面 + 目录 + 章节1 + 章节2 + ... + 结束页` 顺序拼接
6. **拼接后检查**：确认页码连贯、navbar 标记正确、无重复标题

> **为什么要并行？** 每章的内容是独立的，Agent 之间没有数据依赖。并行生成可以显著缩短长演示文稿（20+ 页）的生成时间。

#### 5.1 主 Agent 生成部分

主 Agent 直接生成以下内容（不通过子 Agent）：

**文件头（Frontmatter）**

每个生成的文件必须以以下 frontmatter 开头：

```yaml
---
marp: true
size: 16:9
theme: am_consulting
paginate: true
headingDivider: [2,3]
footer: \ *部门/作者名* *演示文稿标题* *日期*
---
```

- `footer` 中的三段内容用 `\ *内容1* *内容2* *内容3*` 格式，注意反斜杠后有空格
- `headingDivider: [2,3]` 表示 `##` 和 `###` 标题会自动分页

#### 5.2 封面页

```markdown
<!-- _class: cover_c -->
<!-- _header: "" -->
<!-- _footer: "" -->
<!-- _paginate: "" -->

![bg](图片URL或本地路径)

# <!-- fit --> 主标题

###### 副标题说明

作者/部门 · 日期 · 备注
```

封面页可选样式：
- `cover_a`：全幅色带风格
- `cover_b`：左侧色条风格
- `cover_c`：图片背景风格（需要 `![bg](图片路径)`）

#### 5.3 目录页

```markdown
## 目录

<!-- _class: toc_a -->
<!-- _header: "CONTENTS" -->
<!-- _footer: "" -->
<!-- _paginate: "" -->

- [第一章标题](#1-第一章标题)
- [第二章标题](#2-第二章标题)
- [第三章标题](#3-第三章标题)
```

**链接格式**：目录链接必须使用 heading slug 锚点（`#heading-slug`），不要使用数字页码（`#4`）。slug 由目标过渡页 `##` 标题自动生成：小写化、空格转连字符、去除标点。例如 `## 1. 第一章标题` → `#1-第一章标题`。

#### 5.4 过渡页

```markdown
## 章节标题

<!-- _class: trans -->
<!-- _footer: "" -->
<!-- _paginate: "" -->
```

#### 5.5 内容页模板

**普通页（无布局）**：
```markdown
## 页面标题

<!-- _class: navbar -->
<!-- _header: \ *章节1* **当前章节** *章节3* *章节4* -->

- 内容项 1
- 内容项 2
- ...
```

**左右分栏**：
```markdown
## 页面标题

<!-- _class: cols-2 navbar -->
<!-- _header: \ *章节1* **当前章节** *章节3* -->

<div class="ldiv">

#### 左栏标题

- 左栏内容

</div>

<div class="rdiv">

#### 右栏标题

- 右栏内容

</div>
```

**左右分栏（非对称）**：
- `cols-2-64`：左 60% / 右 40%
- `cols-2-73`：左 70% / 右 30%
- `cols-2-46`：左 40% / 右 60%
- `cols-2-37`：左 30% / 右 70%

用法与 `cols-2` 相同，只需更换 `_class` 中的布局名。

**三栏布局**：
```markdown
## 页面标题

<!-- _class: cols-3 -->

<div class="ldiv">

#### 左栏标题
- 内容

</div>

<div class="mdiv">

#### 中栏标题
- 内容

</div>

<div class="rdiv">

#### 右栏标题
- 内容

</div>
```

**上下分栏**：
```markdown
## 页面标题

<!-- _class: rows-2 -->

<div class="tdiv">

#### 上方内容
- 内容

</div>

<div class="bdiv">

#### 下方内容
- 内容

</div>
```

上下分栏可选：`rows-2`、`rows-2-64`、`rows-2-73`、`rows-2-46`、`rows-2-37`

**图片放置**：
- 在分栏中放图片时，将 `ldiv`/`rdiv` 改为 `limg`/`rimg` 以居中对齐
- 图片尺寸用 `![w:420](路径)` 控制宽度

**引用盒子页**：
```markdown
## 页面标题

<!-- _class: bq-green -->

> **引用标题**
> 引用正文内容

- 补充要点 1
- 补充要点 2
```

可选颜色：`bq-green`（洞察）、`bq-red`（警示）、`bq-blue`（信息）、`bq-black`（总结）

**脚注页**：
```markdown
## 页面标题

<!-- _class: footnote -->

<div class="tdiv">

正文内容

</div>

<div class="bdiv">

1 脚注引用来源
2 第二条脚注

</div>
```

**结束页**：
```markdown
---

<!-- _class: lastpage -->
<!-- _footer: "" -->
<!-- _paginate: "" -->

## 感谢聆听

欢迎交流与讨论
```

#### 5.6 章节 Agent 并行调度（核心步骤）

完成主 Agent 部分（frontmatter + 封面 + 目录）后，按以下方式为每个章节启动并行 Agent：

**Agent Prompt 模板（每个章节 Agent 收到的指令）：**

```
你是一个 Marp 演示文稿章节生成器。请根据以下规划生成该章节的 Markdown 内容。

## 你的任务
生成「{章节名}」的所有页面 Markdown。

## 页面规划
{该章的页面规划表，含页码/标题/布局/内容来源}

## navbar 规则
所有内容页使用 navbar，header 格式：
<!-- _header: \ *{章1}* **{当前章（粗体）}** *{章3}* *{章4}* *{章5}* -->

## 源内容（从 PDF 提取）
{粘贴该章对应的 extracted.json 文字内容}

## 可用图片
{列出该章用到的图片文件名及像素尺寸}

## 关键规则
1. 每个 bullet 必须是完整句子，禁止短语堆砌
2. 每页标题下方第一行必须有总起句（普通段落，概括整页内容）
3. 图片路径写 `images/xxx.png`（相对于 output/ 目录）
4. 图片宽度用 Marp 指令：横图 ![w:500]~![w:750]，竖图 ![w:280]~![w:380]
5. 严格遵守内容上限，宁少勿溢
6. 每个 ## 或 ### 标题会自动分页，不需要写 --- 分隔符
7. 不要包含 frontmatter（---marp: true---），只输出纯内容

## 输出格式
直接输出 Markdown 文本，从该章的过渡页开始（## {章节号}. {章节名}），
到该章最后一个内容页结束。不要输出其他解释文字。
```

**调度代码模式（主 Agent 应这样调用）：**

在同一条消息中并行启动所有章节 Agent：
- 每个 Agent 使用 `Task` 工具，`subagent_type: "general-purpose"`
- 所有 `Task` 调用放在同一条消息中以实现并行
- 每个 Agent 的 prompt 按上方模板填入该章的具体内容

**收集与拼接：**

所有 Agent 返回后，主 Agent 按顺序拼接：
1. frontmatter + 封面 + 目录（已生成）
2. 章节 1 Agent 返回的 Markdown
3. 章节 2 Agent 返回的 Markdown
4. ...
5. 结束页（主 Agent 生成）

拼接时在每个章节之间加两个空行 `\n\n`。拼接完成后检查 navbar 标记是否正确。

#### 5.7 navbar 用法

当使用 `navbar` 时，需要在 `_header` 中列出所有章节标题，当前章节用 `**粗体**`，其他用 `*斜体*`：

```markdown
<!-- _class: cols-2 navbar -->
<!-- _header: \ *章节一* **当前章节** *章节三* *章节四* -->
```

注意：`_header` 的 `\` 后有一个空格。

#### 5.8 嵌入交互组件

从 `components/` 目录中选择需要的组件文件，将其中的 `<style scoped>` 块和 HTML 结构复制到对应的 Marp 页面中。替换所有 `{{PLACEHOLDER}}` 占位符为实际数据。

例如嵌入进度条：
```markdown
## 数据概览

<style scoped>
/* 从 components/progress-bars.html 复制的样式 */
</style>

<!-- 从组件文件复制的 HTML 结构，替换占位符 -->
```

#### 5.9 内容量检查（最关键的一步）

**生成每一页内容后，都必须对照 `docs/content-limits.md` 检查该页的内容量是否超标。**

检查清单：
- [ ] 列表条目数是否超过该布局的上限？
- [ ] 表格行列数是否超过该布局的上限？
- [ ] 使用 navbar 时，是否已扣减约 15% 的容量？
- [ ] 每条列表项的文字长度是否合理（过长的单条也会导致溢出）？
- [ ] 混合内容（列表+表格、引用+列表）的总量是否在限制范围内？
- [ ] 嵌套列表的子项是否已按 0.7 折算计入？

**如果内容超标，必须拆分为多页或精简内容。宁可内容偏少，也绝不允许溢出。**

#### 5.10 写入文件

将完整的 Markdown 内容写入文件：
- 文件路径：`output/presentation.md`
- 确保文件编码为 UTF-8

---

### Step 6: 导出

使用 marp CLI 将 Markdown 导出为 HTML 和 PDF 两种格式。

#### 6.1 导出 HTML（支持交互组件）

```bash
marp output/presentation.md --theme-set themes/am_consulting.scss --html -o output/presentation.html
```

#### 6.2 导出 PDF（通用分享）

```bash
marp output/presentation.md --theme-set themes/am_consulting.scss --html --pdf --allow-local-files -o output/presentation.pdf
```

#### 6.3 处理导出错误

如果 marp 命令不可用：
```bash
# 检查是否已安装
which marp || npx @marp-team/marp-cli --version

# 如果未安装，提示用户
# npm install -g @marp-team/marp-cli
```

如果导出失败，检查：
- 主题文件路径是否正确：`ls themes/am_consulting.scss`
- 是否有图片路径问题（本地图片需要 `--allow-local-files`）

---

### Step 7: 告知文件位置并询问修改

导出完成后，**必须**明确告知用户生成文件的完整路径：

> 演示文稿已生成完毕！文件位置如下：
>
> - **Markdown 源文件**：`output/presentation.md`（可直接编辑）
> - **HTML 版本**：`output/presentation.html`（支持交互组件，用浏览器打开）
> - **PDF 版本**：`output/presentation.pdf`（通用格式，可直接分享）
> - **提取的图片**：`output/images/` 目录下
>
> 你对生成结果满意吗？我可以帮你：
> 1. 修改某些页面的内容或布局
> 2. 增加或删除页面
> 3. 调整样式风格
> 4. 添加或修改交互组件
> 5. 重新导出

如果用户要求修改：
- 直接修改 `output/presentation.md` 中对应的页面
- 修改后重新执行 Step 6 的导出命令
- 再次告知文件路径

重复此迭代过程，直到用户满意为止。

---

## 关键规则（必须遵守）

1. **使用完整句子，禁止短语堆砌** — 所有列表项和 bullet 必须是完整句子，表达完整观点。禁止写 "市场规模"、"增长率 12%"、"成本优势" 之类的孤立短语。正确写法："中国市场规模已突破 3000 亿元"、"全年增长率达 12%，超出行业平均"。表格单元格可以简洁短语，但 bullet 列表必须完整句子。

2. **每页必须有总起句** — 每页内容页（封面、目录、过渡页、结束页除外）在标题下方第一行必须有一句总起句，概括整页核心内容。总起句为不带 bullet 的普通段落，写在 `_header` 之后、列表或 div 之前。主题 CSS 已为所有 Grid 布局（cols-2/cols-3/rows-2/footnote 及其变体）内置 `leadtext` 网格区域，会自动将 section 的直接子级 `<p>` 放在标题与面板之间，无需额外 HTML 标记，直接写普通段落即可。示例："ACE 通过增量更新机制在延迟和费用两方面均大幅优于传统方法。"

3. **图片必须读取像素尺寸决定布局** — 根据 extracted.json 中的 width × height 像素值决定图片布局。横图（w/h>1.3）放宽侧或顶部，竖图放窄侧，小图（高<350px）不独占整栏，需在上下添加文字。详见 Step 2.3。

4. **内容绝对不能超出页面边界** — 这是最高优先级规则。每页内容必须对照 `docs/content-limits.md` 检查。宁可内容偏少也绝不允许溢出。

5. **每页必须检查内容量** — 不要凭感觉判断，必须查阅 content-limits.md 中对应布局的具体数值限制。

6. **优先使用左右分栏** — `cols-2` 系列是最常用、最美观的布局。上下分栏（`rows-2` 系列）仅在内容逻辑确实需要上下关系时使用。

7. **非对称分栏注意内容平衡** — 使用 `cols-2-64`、`cols-2-73` 等非对称布局时，窄侧必须有足够密集的内容（关键指标、数据卡片、紧凑列表），不能留白过多。

8. **navbar 会减少可用空间** — 使用 navbar 时，页面可用内容区域减少约 15%，规划内容时必须扣除这部分。

9. **导出后必须告知文件路径** — 不要只说"已完成"，必须列出所有生成文件的完整路径。

10. **必须询问用户是否需要修改** — 每次导出后都要主动询问，支持迭代优化。

11. **交互组件适度使用** — 每份演示文稿 1-3 个交互组件即可，过多会分散注意力。交互组件仅在 HTML 中生效。

12. **保持专业排版** — 列表项使用简洁的语言，表格列数不宜过多（分栏内最多 4-5 列），长段落应拆分为列表。

13. **图片使用准则** — 封面页优先使用高质量背景图，内容页中图片用于辅助说明而非装饰。从 PDF 提取的图片放在 `output/images/` 下，引用路径必须相对于 .md 文件所在目录（若 .md 在 `output/` 中，则写 `images/xxx.png`，不要写 `output/images/xxx.png`）。
